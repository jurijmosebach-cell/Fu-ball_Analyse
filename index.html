<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fu√üball Analyse - KI Vorhersagen</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #00c6ff, #0072ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .filters {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .filter-select {
            padding: 10px 15px;
            border: none;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.9);
            color: #333;
            font-size: 14px;
            min-width: 150px;
        }
        
        .games-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .game-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: transform 0.3s ease;
        }
        
        .game-card:hover {
            transform: translateY(-5px);
            background: rgba(255, 255, 255, 0.15);
        }
        
        .teams {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .team {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            flex: 1;
        }
        
        .team-logo {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            margin-bottom: 8px;
            background: rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }
        
        .team-name {
            font-weight: bold;
            font-size: 14px;
        }
        
        .vs {
            margin: 0 15px;
            font-weight: bold;
            color: #00c6ff;
        }
        
        .probabilities {
            display: flex;
            justify-content: space-around;
            margin: 15px 0;
            background: rgba(255, 255, 255, 0.1);
            padding: 10px;
            border-radius: 10px;
        }
        
        .prob-item {
            text-align: center;
        }
        
        .prob-label {
            font-size: 12px;
            opacity: 0.8;
            margin-bottom: 5px;
        }
        
        .prob-value {
            font-size: 16px;
            font-weight: bold;
            color: #00c6ff;
        }
        
        .trends {
            margin: 15px 0;
        }
        
        .trend-item {
            background: rgba(0, 198, 255, 0.2);
            padding: 8px 12px;
            border-radius: 8px;
            margin-bottom: 8px;
            font-size: 14px;
        }
        
        .trend-item strong {
            color: #00c6ff;
        }
        
        .analysis {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
        }
        
        .analysis-summary {
            font-weight: bold;
            margin-bottom: 8px;
            color: #00c6ff;
        }
        
        .analysis-factors {
            font-size: 13px;
            opacity: 0.9;
        }
        
        .ki-score {
            text-align: center;
            margin-top: 10px;
            padding: 8px;
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
            border-radius: 20px;
            font-weight: bold;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            font-size: 18px;
        }
        
        .error {
            text-align: center;
            padding: 20px;
            background: rgba(255, 0, 0, 0.2);
            border-radius: 10px;
            margin: 20px 0;
        }
        
        .market-trends {
            margin: 10px 0;
        }
        
        .market-trend {
            background: rgba(0, 255, 127, 0.2);
            padding: 8px 12px;
            border-radius: 8px;
            margin-bottom: 5px;
            font-size: 13px;
        }
        
        /* TOP PICKS STYLES */
        .top-picks {
            background: linear-gradient(45deg, #ff6b6b, #c44569);
            padding: 25px;
            border-radius: 15px;
            margin: 30px 0;
            color: white;
            border: 3px solid #ff9ff3;
        }
        
        .top-picks h2 {
            text-align: center;
            margin-bottom: 20px;
            font-size: 1.8em;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        
        .top-picks-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
        }
        
        .top-pick-card {
            background: rgba(255, 255, 255, 0.95);
            color: #333;
            padding: 15px;
            border-radius: 10px;
            border-left: 5px solid #ff9ff3;
        }
        
        .top-pick-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .top-pick-teams {
            font-weight: bold;
            font-size: 16px;
        }
        
        .top-pick-score {
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 14px;
        }
        
        .top-pick-trend {
            background: rgba(0, 198, 255, 0.2);
            padding: 8px;
            border-radius: 6px;
            margin: 8px 0;
            font-size: 13px;
        }
        
        .top-pick-analysis {
            font-size: 13px;
            color: #666;
            margin-top: 8px;
        }

        .premium-picks {
            background: linear-gradient(45deg, #ffd700, #ff8c00);
            padding: 20px;
            border-radius: 15px;
            margin: 30px 0;
            color: #333;
        }
        
        .premium-picks h2 {
            text-align: center;
            margin-bottom: 15px;
            color: #333;
        }
        
        @media (max-width: 768px) {
            .games-grid {
                grid-template-columns: 1fr;
            }
            
            .filters {
                flex-direction: column;
                align-items: center;
            }
            
            .filter-select {
                width: 100%;
                max-width: 300px;
            }
            
            .top-picks-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>‚öΩ KI Fu√üball Analyse</h1>
            <p>Multi-Market Trends & Ensemble Vorhersagen</p>
        </div>

        <div class="filters">
            <select id="dateSelect" class="filter-select">
                <option value="">Datum ausw√§hlen...</option>
            </select>
            <select id="leagueSelect" class="filter-select">
                <option value="">Alle Ligen</option>
            </select>
            <button onclick="loadGames()" class="filter-select" style="background: #00c6ff; color: white; cursor: pointer;">
                üîÑ Aktualisieren
            </button>
        </div>

        <div id="loading" class="loading">
            üìä Lade Spiele und KI-Analysen...
        </div>

        <div id="error" class="error" style="display: none;">
            ‚ùå Fehler beim Laden der Daten
        </div>
          <!-- NEUE TOP PICKS SEKTION -->
        <div id="topPicks" class="top-picks" style="display: none;">
            <h2>üèÜ TOP PICKS - Beste Wetten des Tages</h2>
            <div id="topPicksContent" class="top-picks-grid"></div>
        </div>

        <div id="premiumPicks" class="premium-picks" style="display: none;">
            <h2>üíé Premium Picks - Exklusive Trends</h2>
            <div id="premiumContent"></div>
        </div>

        <div id="gamesGrid" class="games-grid"></div>
    </div>

    <script>
        // Fehlerbehandlung f√ºr alle Funktionen
        function safeGet(object, path, defaultValue = 'N/A') {
            try {
                const value = path.split('.').reduce((obj, key) => obj && obj[key], object);
                return value !== undefined && value !== null ? value : defaultValue;
            } catch (error) {
                return defaultValue;
            }
        }

        function safeUpperCase(str) {
            try {
                return String(str || '').toUpperCase();
            } catch (error) {
                return 'N/A';
            }
        }

        function safeNumber(num, decimals = 1) {
            try {
                const value = parseFloat(num);
                return isNaN(value) ? '0.0' : value.toFixed(decimals);
            } catch (error) {
                return '0.0';
            }
        }
         // Hauptfunktionen
        async function loadGames() {
            const loading = document.getElementById('loading');
            const error = document.getElementById('error');
            const gamesGrid = document.getElementById('gamesGrid');
            const topPicks = document.getElementById('topPicks');
            const premiumPicks = document.getElementById('premiumPicks');
            
            loading.style.display = 'block';
            error.style.display = 'none';
            gamesGrid.innerHTML = '';
            topPicks.style.display = 'none';
            premiumPicks.style.display = 'none';

            try {
                const dateSelect = document.getElementById('dateSelect');
                const leagueSelect = document.getElementById('leagueSelect');
                
                const date = dateSelect.value || new Date().toISOString().split('T')[0];
                const league = leagueSelect.value;
                
                const apiUrl = `/api/games?date=${date}${league ? `&league=${encodeURIComponent(league)}` : ''}`;
                
                console.log('Lade Daten von:', apiUrl);
                
                const response = await fetch(apiUrl);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                if (!data.response || !Array.isArray(data.response)) {
                    throw new Error('Ung√ºltiges Datenformat');
                }
                
                displayGames(data.response);
                updateTopPicks(data.response); // NEUE FUNKTION
                updatePremiumPicks(data.response);
                populateFilters(data.info);
                
            } catch (error) {
                console.error('Fehler beim Laden:', error);
                document.getElementById('error').style.display = 'block';
                document.getElementById('error').innerHTML = `‚ùå Fehler: ${error.message}`;
            } finally {
                loading.style.display = 'none';
            }
        }

        function displayGames(games) {
            const gamesGrid = document.getElementById('gamesGrid');
            
            if (!games || games.length === 0) {
                gamesGrid.innerHTML = '<div class="game-card" style="text-align: center; grid-column: 1/-1;">Keine Spiele f√ºr diesen Tag gefunden</div>';
                return;
            }

            gamesGrid.innerHTML = games.map(game => `
                <div class="game-card">
                    <div class="teams">
                        <div class="team">
                            <div class="team-logo">
                                ${getTeamFlag(safeGet(game, 'home'))}
                            </div>
                            <div class="team-name">${safeGet(game, 'home', 'Unbekannt')}</div>
                        </div>
                        <div class="vs">VS</div>
                        <div class="team">
                            <div class="team-logo">
                                ${getTeamFlag(safeGet(game, 'away'))}
                            </div>
                            <div class="team-name">${safeGet(game, 'away', 'Unbekannt')}</div>
                        </div>
                    </div>
                    
                    <div class="probabilities">
                        <div class="prob-item">
                            <div class="prob-label">Heim</div>
                            <div class="prob-value">${safeNumber(safeGet(game, 'prob.home', 0) * 100)}%</div>
                        </div>
                        <div class="prob-item">
                            <div class="prob-label">Unent.</div>
                            <div class="prob-value">${safeNumber(safeGet(game, 'prob.draw', 0) * 100)}%</div>
                        </div>
                        <div class="prob-item">
                            <div class="prob-label">Ausw.</div>
                            <div class="prob-value">${safeNumber(safeGet(game, 'prob.away', 0) * 100)}%</div>
                        </div>
                    </div>
                    
                    ${renderMarketTrends(game)}
                    ${renderAnalysis(game)}
                    
                    <div class="ki-score">
                        KI Score: ${safeNumber(safeGet(game, 'kiScore', 0) * 100)}%
                    </div>
                </div>
            `).join('');
        }

        // ULTRA-LOCKERE TOP PICKS FUNKTION
        function updateTopPicks(games) {
            const topPicks = document.getElementById('topPicks');
            const topPicksContent = document.getElementById('topPicksContent');
            
            if (!games || games.length === 0) {
                topPicks.style.display = 'none';
                return;
            }

            console.log(`üîç Analysiere ${games.length} Spiele f√ºr Top Picks...`);

            // ULTRA-LOCKERE KRITERIEN - Hauptsache Spiele vorhanden
            const topPicksGames = games
                .filter(game => {
                    const kiScore = safeGet(game, 'kiScore', 0);
                    const confidence = safeGet(game, 'confidence', 0);
                    
                    // NUR NOCH 2 BASIS-KRITERIEN
                    return kiScore > 0.3 &&    // Reduziert auf 0.3
                           confidence > 0.3;   // Reduziert auf 0.3
                })
                .sort((a, b) => safeGet(b, 'kiScore', 0) - safeGet(a, 'kiScore', 0))
                .slice(0, 6);

            console.log(`üéØ Gefundene Top Picks: ${topPicksGames.length}`);

            // FALLBACK: Wenn immer noch keine, nimm einfach die besten 4 nach kiScore
            if (topPicksGames.length === 0 && games.length > 0) {
                const fallbackPicks = games
                    .sort((a, b) => safeGet(b, 'kiScore', 0) - safeGet(a, 'kiScore', 0))
                    .slice(0, 4);
                
                console.log(`üîÑ Verwende Fallback mit ${fallbackPicks.length} Spielen`);
                // Array leeren und Fallback hinzuf√ºgen
                topPicksGames.length = 0;
                topPicksGames.push(...fallbackPicks);
            }

            if (topPicksGames.length === 0) {
                topPicks.style.display = 'none';
                return;
            }

            topPicksContent.innerHTML = topPicksGames.map(game => {
                const bestTrend = safeGet(game, 'marketTrends.bestTrend');
                const analysis = safeGet(game, 'analysis');
                const marketTrends = safeGet(game, 'marketTrends');
                
                // Flexiblere Trend-Findung
                let displayTrend = bestTrend;
                if (!displayTrend && marketTrends && marketTrends.allTrends && marketTrends.allTrends.length > 0) {
                    displayTrend = marketTrends.allTrends[0];
                }
                
                // Fallback: Erstelle eigenen Trend aus Wahrscheinlichkeiten
                if (!displayTrend) {
                    const homeProb = safeGet(game, 'prob.home', 0);
                    const awayProb = safeGet(game, 'prob.away', 0);
                    const drawProb = safeGet(game, 'prob.draw', 0);
                    
                    let bestMarket = 'Heimsieg';
                    let bestProb = homeProb;
                    
                    if (awayProb > bestProb) {
                        bestMarket = 'Ausw√§rtssieg';
                        bestProb = awayProb;
                    }
                    if (drawProb > bestProb - 0.1) { // Draw muss nicht zwingend h√∂her sein
                        bestMarket = 'Unentschieden';
                        bestProb = drawProb;
                    }
                    
                    displayTrend = {
                        market: bestMarket,
                        probability: bestProb,
                        description: `${bestMarket} mit ${(bestProb * 100).toFixed(1)}% Wahrscheinlichkeit`
                    };
                }

                return `
                    <div class="top-pick-card">
                        <div class="top-pick-header">
                            <div class="top-pick-teams">
                                ${safeGet(game, 'home')} vs ${safeGet(game, 'away')}
                            </div>
                            <div class="top-pick-score">
                                ${safeNumber(safeGet(game, 'kiScore', 0) * 100)}%
                            </div>
                        </div>
                        
                        <div style="font-size: 12px; color: #666; margin-bottom: 8px;">
                            ${safeGet(game, 'league')} ‚Ä¢ Confidence: ${safeNumber(safeGet(game, 'confidence', 0) * 100)}%
                            ${safeGet(game, 'analysis.riskLevel') ? `<br>Risiko: ${safeGet(game, 'analysis.riskLevel')}` : ''}
                        </div>
                        
                        <div class="top-pick-trend">
                            üéØ <strong>${safeGet(displayTrend, 'market', 'Top Empfehlung')}</strong><br>
                            ${safeGet(displayTrend, 'description', 'KI-basierte Vorhersage')}<br>
                            <small>Wahrscheinlichkeit: ${safeNumber(safeGet(displayTrend, 'probability', 0) * 100)}%</small>
                        </div>
                        
                        ${analysis ? `
                            <div class="top-pick-analysis">
                                <strong>${safeGet(analysis, 'summary', 'KI-Analyse verf√ºgbar')}</strong><br>
                                ${safeGet(analysis, 'recommendation', 'Empfohlen basierend auf KI-Berechnungen')}
                            </div>
                        ` : `
                            <div class="top-pick-analysis">
                                <strong>KI-Empfehlung</strong><br>
                                Basierend auf Ensemble-Modell mit ${safeNumber(safeGet(game, 'kiScore', 0) * 100)}% KI-Score
                            </div>
                        `}
                    </div>
                `;
            }).join('');

            topPicks.style.display = 'block';
        }

        function renderMarketTrends(game) {
            const marketTrends = safeGet(game, 'marketTrends');
            if (!marketTrends || !marketTrends.bestTrend) {
                return '<div class="trends"><div class="trend-item">üìä Trends werden analysiert...</div></div>';
            }

            const bestTrend = marketTrends.bestTrend;
            return `
                <div class="market-trends">
                    <div class="market-trend">
                        üéØ <strong>Top Trend:</strong> ${safeGet(bestTrend, 'market', 'Unbekannt')} 
                        (${safeNumber(safeGet(bestTrend, 'probability', 0) * 100)}% | Confidence: ${safeNumber(safeGet(bestTrend, 'confidence', 0) * 100)}%)
                    </div>
                    <div class="market-trend">
                        üìà ${safeGet(bestTrend, 'description', 'Trend analysiert')}
                    </div>
                </div>
            `;
        }

        function renderAnalysis(game) {
            const analysis = safeGet(game, 'analysis');
            if (!analysis) {
                return '';
            }

            return `
                <div class="analysis">
                    <div class="analysis-summary">${safeGet(analysis, 'summary', 'Analyse wird berechnet...')}</div>
                    <div class="analysis-factors">
                        ${(safeGet(analysis, 'keyFactors', [])).slice(0, 3).map(factor => 
                            `‚Ä¢ ${safeGet(factor, 'toString', factor)}`
                        ).join('<br>')}
                    </div>
                </div>
            `;
        }

        function updatePremiumPicks(games) {
            const premiumPicks = document.getElementById('premiumPicks');
            const premiumContent = document.getElementById('premiumContent');
            
            if (!games || games.length === 0) {
                premiumPicks.style.display = 'none';
                return;
            }

            // Lockere Kriterien f√ºr Premium Picks
            const premiumGames = games
                .filter(game => safeGet(game, 'kiScore', 0) > 0.4) // Reduziert von 0.6
                .sort((a, b) => safeGet(b, 'kiScore', 0) - safeGet(a, 'kiScore', 0))
                .slice(0, 4); // Erh√∂ht auf 4

            if (premiumGames.length === 0) {
                premiumPicks.style.display = 'none';
                return;
            }

            premiumContent.innerHTML = premiumGames.map(game => {
                const bestTrend = safeGet(game, 'marketTrends.bestTrend');
                return `
                    <div class="game-card" style="background: rgba(255,255,255,0.9); color: #333; margin: 10px 0;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong>${safeGet(game, 'home', 'Heim')} vs ${safeGet(game, 'away', 'Ausw√§rts')}</strong>
                                <br>
                                <small>${safeGet(game, 'league', 'Liga unbekannt')}</small>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 18px; font-weight: bold; color: #0072ff;">
                                    ${safeNumber(safeGet(game, 'kiScore', 0) * 100)}%
                                </div>
                                <small>KI Confidence</small>
                            </div>
                        </div>
                        ${bestTrend ? `
                            <div style="margin-top: 10px; padding: 8px; background: rgba(0, 198, 255, 0.2); border-radius: 5px;">
                                üéØ <strong>Empfehlung:</strong> ${safeGet(bestTrend, 'market')} 
                                (${safeNumber(safeGet(bestTrend, 'probability', 0) * 100)}%)
                            </div>
                        ` : `
                            <div style="margin-top: 10px; padding: 8px; background: rgba(0, 198, 255, 0.2); border-radius: 5px;">
                                üìä <strong>Top-Wahl:</strong> Heim ${safeNumber(safeGet(game, 'prob.home', 0) * 100)}% | 
                                Unent. ${safeNumber(safeGet(game, 'prob.draw', 0) * 100)}% | 
                                Ausw. ${safeNumber(safeGet(game, 'prob.away', 0) * 100)}%
                            </div>
                        `}
                    </div>
                `;
            }).join('');

            premiumPicks.style.display = 'block';
        }

        function populateFilters(info) {
            // Datum-Filter
            const dateSelect = document.getElementById('dateSelect');
            if (dateSelect.options.length <= 1) {
                const today = new Date();
                for (let i = -2; i <= 7; i++) {
                    const date = new Date();
                    date.setDate(today.getDate() + i);
                    const dateString = date.toISOString().split('T')[0];
                    const option = document.createElement('option');
                    option.value = dateString;
                    option.textContent = date.toLocaleDateString('de-DE');
                    if (i === 0) option.selected = true;
                    dateSelect.appendChild(option);
                }
            }

            // Liga-Filter
            const leagueSelect = document.getElementById('leagueSelect');
            if (leagueSelect.options.length <= 1 && info && info.leagues) {
                safeGet(info, 'leagues', []).forEach(league => {
                    const option = document.createElement('option');
                    option.value = league;
                    option.textContent = league;
                    leagueSelect.appendChild(option);
                });
            }
        }

        function getTeamFlag(teamName) {
            const team = String(teamName || '').toLowerCase();
            
            if (team.includes('manchester') || team.includes('liverpool') || team.includes('arsenal') || 
                team.includes('tottenham') || team.includes('chelsea')) return 'üè¥Û†ÅßÛ†Å¢Û†Å•Û†ÅÆÛ†ÅßÛ†Åø';
            if (team.includes('bayern') || team.includes('dortmund') || team.includes('leipzig')) return 'üá©üá™';
            if (team.includes('real') || team.includes('barcelona') || team.includes('atletico')) return 'üá™üá∏';
            if (team.includes('milan') || team.includes('juventus') || team.includes('inter')) return 'üáÆüáπ';
            if (team.includes('psg') || team.includes('lyon') || team.includes('marseille')) return 'üá´üá∑';
            if (team.includes('benfica') || team.includes('porto') || team.includes('sporting')) return 'üáµüáπ';
            if (team.includes('ajax') || team.includes('psv') || team.includes('feyenoord')) return 'üá≥üá±';
            
            return '‚öΩ';
        }

        // Initialisierung
        document.addEventListener('DOMContentLoaded', function() {
            loadGames();
             // Auto-Refresh alle 2 Minuten
            setInterval(loadGames, 120000);
        });

        // Globale Fehlerbehandlung
        window.addEventListener('error', function(e) {
            console.error('Globaler Fehler:', e.error);
        });

        window.addEventListener('unhandledrejection', function(e) {
            console.error('Nicht behandelter Promise Fehler:', e.reason);
        });
    </script>
</body>
</html>
